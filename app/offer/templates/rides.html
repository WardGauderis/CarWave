{% extends 'base.html' %}
{% import 'bootstrap/wtf.html' as wtf %}

{#do not delete this!!!!1#}
{% block app_styles %}
    <link rel="stylesheet" href="{{ url_for('.static', filename='leaflet.css') }}"/>
    <link rel="stylesheet" href="{{ url_for('.static', filename='leaflet-routing-machine.css') }}"/>
{% endblock %}

{% block app_content %}
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap">
        <h1 class="display-4 col-sm-7">{{ title }}</h1>

        {% if time is defined and time == 'future' or time == 'past' or time == 'all' %}
            <ul class="pagination" style="margin-bottom: 0; align-items: end">
                <li class="page-item {% if time == 'future' %} active {% endif %}">
                    <a class="page-link" href="{{ url_for(request.url_rule.endpoint, time='future') }}">Future</a>

                <li class="page-item {% if time == 'past' %} active {% endif %}">
                    <a class="page-link" href="{{ url_for(request.url_rule.endpoint, time='past') }}">Past</a>

                <li class="page-item {% if not (time == 'future' or time == 'past') %} active {% endif %}">
                    <a class="page-link" href="{{ url_for(request.url_rule.endpoint, time='all') }}">All</a>
            </ul>
        {% endif %}
    </div>
    <hr>

    {% if details is defined %}
        <div class="card m-3">
            <div class=" card-body">
                {{ wtf.quick_form(details) }}
            </div>
        </div>
    {% endif %}

    {% if rides is defined %}
        {% if not rides %}
            <h4>{{ none_found }}</h4>
        {% endif %}
        {% for ride in rides %}
            {% include '_ride.html' %}
        {% endfor %}
    {% elif requests is defined %}
        {% if not requests %}
            <h4>{{ none_found }}</h4>
        {% endif %}
        {% for request in requests %}
            {% set ride = request.ride %}
            {% include '_ride.html' %}
        {% endfor %}
    {% endif %}

    <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
            {% if prev_url %}
                <li class="page-item"><a class="page-link" href="{{ prev_url }}">previous</a></li>
            {% endif %}
            {% if next_url %}
                <li class="page-item"><a class="page-link" href="{{ next_url }}">next</a></li>
            {% endif %}
        </ul>
    </nav>

{% endblock %}

{% block app_scripts %}
    <script type="text/javascript">
        function address_to_string(address) {
            let res = '';
            if (address.road != null) res += address.road + ', ';

            if (address.town != null) res += address.town + ', ';
            else if (address.city != null) res += address.city + ', ';

            if (address.county != null) res += address.county + ', ';
            if (address.country != null) res += address.country;
            return res;
        }

        function get_address(ids) {
            let url = "https://nominatim.openstreetmap.org/lookup?osm_ids=";
            for (let i = 0; i < ids.length; i++) {
                url += ids[i].from_id + ',';
                url += ids[i].to_id + ',';
            }
            url = url.substring(0, url.length - 1);
            url += "&format=json";
            console.log(url);

            $.ajax({
                url: url,
                type: "GET",
                success: function (xhr) {
                    for (let i = 0; i < ids.length; i++) {
                        document.getElementById("from1" + ids[i].ride_id).innerText = address_to_string(xhr[2 * i].address);
                        document.getElementById("to1" + ids[i].ride_id).innerText = address_to_string(xhr[2 * i + 1].address);
                    }
                },
                error: function (xhr) {
                    console.log(xhr)
                }
            });
        }

        let ids = [
            {% for ride in rides %}
                {from_id: '{{ ride.departure_id }}', to_id: '{{ ride.arrival_id }}', ride_id: '{{ ride.id }}'},
            {% endfor %}
            {% for request in requests %}
                {from_id: '{{ request.ride.departure_id }}', to_id: '{{ request.ride.arrival_id }}', ride_id: '{{ request.ride.id }}'},
            {% endfor %}
        ];
        get_address(ids);
    </script>
{% endblock %}