<div class="card m-2">
    <div class=" card-header">
        <nav>
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a class="nav-item nav-link active" data-toggle="tab"
                       href="#body-overview-{{ ride.id }}">Overview</a>
                </li>
                <li class="nav-item">
                    <a class="nav-item nav-link" data-toggle="tab"
                       href="#body-map-{{ ride.id }}">Map</a>
                </li>
                <li class="nav-item">
                    <a class="nav-item nav-link" data-toggle="tab"
                       href="#body-car-{{ ride.id }}">Car</a>
                </li>
                {% if passenger is defined %}
                    <li class="nav-item">
                        <a class="nav-item nav-link" data-toggle="tab"
                           href="#body-passenger-{{ ride.id }}">Passenger</a>
                    </li>
                {% endif %}
            </ul>
        </nav>
    </div>

    <div class="tab-content card-body">
        <div class="tab-pane fade show active" id="body-overview-{{ ride.id }}">
            <p>
                <span class="text-left font-weight-bold">From: </span>
                <span id="from1{{ ride.id }}">loading...</span><br>
                <span class="text-left font-weight-bold">To: </span>
                <span id="to1{{ ride.id }}">loading...</span><br>

                <span class="text-left font-weight-bold">Departure Time: </span>
                {% if ride.departure_time %}
                    {{ moment(ride.departure_time).format('LLLL') }}
                {% else %}
                    Unknown
                {% endif %}<br>
                <span class="text-left font-weight-bold">Arrival Time: </span>{{ moment(ride.arrival_time).format('LLLL') }}<br>
                <span class="text-left font-weight-bold">Driver: </span><a
                    href="{{ url_for('profile.user', user_id=ride.driver.id) }}">{{ ride.driver.username }}</a><br>
                <span class="text-left font-weight-bold">Passenger Places Available: </span>{{ ride.passenger_places_left() }}/{{ ride.passenger_places }}<br>
                <span class="text-left font-weight-bold">Current passengers: </span>
                {% for request in ride.accepted_requests().all() %}
                    <a href="{{ url_for('profile.user', user_id=request.passenger.id) }}">{{ request.passenger.username }}</a>
                {% endfor %}<br>
                <span class="text-left font-weight-bold">ID: </span>{{ ride.id }}<br>
            </p>

            {# delete button for the rides which can be edited #}
            {% if delete is defined %}
                <form method="post" name="ride">
                    {{ delete.ride_id(type="hidden", value=ride.id) }}
                    {{ wtf.form_field(delete.edit) }}
                    {{ wtf.form_field(delete.delete,  button_map={'delete':'danger'}) }}
                </form>
            {% endif %}

            {% if delete_req is defined %}
                <form method="post" name="ride">
                    {{ delete_req.ride_id(type="hidden", value=ride.id) }}
                    {{ wtf.form_field(delete_req.delete) }}
                </form>
            {% endif %}

            {% if select is defined %}
                <form method="post" name="ride">
                    {{ select.ride_id(type="hidden", value=ride.id) }}
                    {{ wtf.form_field(select.request) }}
                </form>
            {% endif %}

            {% if choice is defined %}
                <form method="post" name="ride">
                    {{ choice.ride_id(type="hidden", value=ride.id) }}
                    {{ choice.user_id(type="hidden", value=passenger.id) }}
                    <div class="form-row" style="padding:10px">
                        <div class="ui-widget col-sm" style="margin:0">
                            {{ wtf.form_field(choice.accept, button_map={'accept':'success'}) }}
                        </div>
                        <div class="col-sm-auto">
                            {{ wtf.form_field(choice.reject, button_map={'reject':'danger'}) }}
                        </div>
                    </div>
                </form>
            {% endif %}

        </div>
        <div class="tab-pane fade" id="body-map-{{ ride.id }}">
            <div id="map{{ ride.id }}" style="height: 500px;"></div>
        </div>
        <div class="tab-pane fade" id="body-car-{{ ride.id }}">
            {% if ride.car %}
                <span class="text-left font-weight-bold">license_plate: </span>{{ ride.car.license_plate }}<br>
                <span class="text-left font-weight-bold">model: </span>{{ ride.car.model }}<br>
                <span class="text-left font-weight-bold">colour: </span>{{ ride.car.colour }}<br>
                <span class="text-left font-weight-bold">passenger_places: </span>{{ ride.car.passenger_places }}<br>
                <span class="text-left font-weight-bold">build_year: </span>{{ ride.car.build_year }}<br>
                <span class="text-left font-weight-bold">fuel: </span>{{ ride.car.fuel }}<br>
                <span class="text-left font-weight-bold">consumption: </span>{{ ride.car.consumption }}<br>
            {% else %}
                <span class="text-left font-weight-bold">The driver has not yet registered a car for this drive</span>
                <br>
            {% endif %}
        </div>
        {% if passenger is defined %}
            <div class="tab-pane fade" id="body-passenger-{{ ride.id }}">
                User info
            </div>
        {% endif %}
    </div>
</div>

<script src="{{ url_for('.static', filename='jquery.js') }}"></script>
<script src="{{ url_for('.static', filename='leaflet.js') }}"></script>
<script src="{{ url_for('.static', filename='leaflet-routing-machine.js') }}"></script>

<script type="text/javascript">

    function address_to_string(address)
    {
        console.log(address);
        let res = '';
        if(address.road != null) res += address.road + ', ';

        if(address.town != null) res += address.town + ', ';
        else if(address.city != null) res += address.city + ', ';

        if(address.county != null) res += address.county + ', ';
        if(address.country != null) res += address.country;
        return res;
    }
    function get_address(id, which) {
        $.ajax({
            url: "https://nominatim.openstreetmap.org/lookup?osm_ids=" + id + "&format=json",
            type: "GET",
            success: function (xhr) {
                if (which === 'from') {
                    document.getElementById("from1{{ ride.id }}").innerText = address_to_string(xhr[0].address);
                } else {
                    document.getElementById("to1{{ ride.id }}").innerText = address_to_string(xhr[0].address);
                }
            },
            error: function (xhr) {
                alert(xhr)
            }
        });
    }

    get_address('{{ ride.departure_id }}', 'from');
    get_address('{{ ride.arrival_id }}', 'to');

    let map{{ ride.id }} = L.map('map{{ ride.id }}', {
        minZoom: 2,
        maxZoom: 20,
    });

    L.Routing.control({
        show: false,
        showAlternatives: true,
        addWaypoints: false,
        waypoints: [
            L.latLng({{ ride.depart_from }}),
            L.latLng({{ ride.arrive_at }})
        ],
        lineOptions: {
            styles: [{color: '#769ad4', opacity: 0.15, weight: 9},
                {color: '#769ad4', opacity: 0.8, weight: 6},
                {color: '#769ad4', opacity: 1, weight: 2}]
        },

        altLineOptions: {
            styles: [{color: '#b0c5e6', opacity: 0.15, weight: 9},
                {color: '#b0c5e6', opacity: 0.8, weight: 6},
                {color: '#b0c5e6', opacity: 1, weight: 2}]
        },
        router: L.Routing.mapbox('pk.eyJ1IjoiZnVua3ltYW5pYWMiLCJhIjoiY2s2dDZzeGlxMG1lNzNmcGdoZGljdnp0bCJ9.5WI4sA19cj8iCPNkZemm9Q'),
    }).addTo(map{{ ride.id }});

    L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map{{ ride.id }});

    $(document).ready(function () {
        $('.nav-tabs a').on('shown.bs.tab', function () {
            map{{ ride.id }}.invalidateSize();
            map{{ ride.id }}.setZoom(9);
        });
    });

</script>